---
title: "Modelling _E. coli_ die-off in mini trials"
author: "Nicholas Waters"
date: "2/5/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rstan)
library(GGally)
ggplot2::theme_set(ggplot2::theme_minimal() + ggplot2::theme(
  rect = element_rect(fill = "transparent"),
  #plot.background = element_rect(fill = "#FAFAFA", color=NA),
  plot.background = element_rect(fill = "transparent", color=NA),
  axis.text = element_text(size=12),
  strip.background = element_rect(fill = "grey95", color=NA),
  strip.text = element_text(face="bold"),
  axis.title  = element_text(size=16),
  panel.grid.minor.x = element_blank(),
  title = element_text(size=20), 
  plot.caption=element_text(hjust = 0),
  legend.text =  element_text(size=12), plot.subtitle = element_text(size=12, colour = "grey60"),
  legend.position = "bottom"
)
)
fn = local({
  # from https://github.com/yihui/knitr-examples/blob/master/070-caption-num.Rmd 
  
  i = 0
  function(x) {
    i <<- i + 1
    paste('Figure ', i, ': ', x, sep = '')
  }
})

options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

## Introduction

## The Data

### Main dataset
Data is stored in this repo's `data` dir.  The `raw` directory contains the raw data files recieved, which were copied to the `clean` dir, and modified as needed. 

The bulk of the data was from file "Box Behnken analysis.xlsx", recieved from RN via Skype on 2019-02-27, and this file was an updated version of the earlier "All Raw Data Mini Trial.xlsx" file.  The data were in the "Block on rep" and "methane" tabs.

The main changes to "Box Behnken analysis" that were made:
- label OLR was changed to OL to reflect the time-independant nature of the value
- label HRT was changed to time, for the inverse reason
- the methane aggretation was fixed to prevent values from being summed twice
- addition of an "export" tab, for exporting to csv.

All these changes can be found in "./data/clean/Box Behnken analysis_nick_27.02.19.xlsx", and exported as "./data/clean/trial_data.csv".

### Day 0 Values
After discussion about the experimental setup and the move to a time-based model rather than the Box Behnken analysis, we requested the Day 0 values for the 3 feedstocks, innoculum, and their mixtures. The file "Mini Trial FS FIB TS&VS.xlsx" was recieved 2019-04-30 from SN.  

Data was aggregated and exported as "./data/clean/day0.csv" from the "day0" worksheet I added.

### Processed data
The results of the two datasets are combined and written to the `clean` folder as `cleaned_combined_minitrial_data.csv`.

### A note about experimental design and terms
Three things are mixed in these reractors: slurry, Food waste, and the iccoculum (from an AD reactor)
Recipe may be used interchangably with Feedstock.
There are 3 recipes, with different slurry:food waste ratios of 1:2, 1:3, and 3:1.

- *OL*: organic load, expressed in g VS/L
- sCOD: the soluble Chemical Oxygen Demand


## Todo
- incorporate innoculumn sCOD values when recieved; either retest orr impute pH.  

## Data explorations

First thing we did was read in the main data file and merge it with the day 0 data. Because the day zero are true for all temperatures, we duplicate the data for the 19 and 55 degree conditions. Then, we convert log-scale the the indicator bacteria counts, adding a dummy value of 1 to prevent errors of logging 0.


```{r reading_data}
main_data <- read.csv("./data/clean/trial_data.csv")
day0 <- read.csv("./data/clean/day0.csv", skip=3, skipNul = T, stringsAsFactors = F)
day0 <- day0 %>% select(-fs_conc, -fs_vol, -inoc_conc, -inoc_vol) %>% spread(key = measurement, value = Value)
day0<- rbind(
  day0,
  day0 %>% transform(Temp=replace(Temp,Temp==37, 19)),
  day0 %>% transform(Temp=replace(Temp,Temp==37, 55))
) 
names(sn_raw)
names(day0)
sn_raw <- rbind(main_data, day0)

sn <- sn_raw %>%
  rowwise() %>% 
  transform(
    Recipe=as.factor(Recipe),
    Ecoli =  log10(Ecoli + 1),
    Coliforms = log10(Coliforms + 1),
    Enterococci = log10(Enterococci + 1))
summary(sn)
```

It may prove useful to note the components of the three recipes.  The organic loading rates were calcualted based on the volitile solid quantity.  the recepies are ratios of 2 of three ingrrerdiates (not including the innoculum, which is added as discussed above):  dairy cattle slurry(DCS), Fats Oils and Grease (FOG), and restauraant food waste (RFW).
- FWS12: 1:2 FOG:DCS
- FWS13: DCS:RFW 1:3 
- FWS31: DCS:RFW 3:1  

We add those proportion to the data.  Then, we save the cleaned, prepated data. 

```{r}
recipes <- data.frame(
  Recipe= c("FWS12","FWS13","FWS31"),
  RFW= as.factor(round(c(0, 3/4, 1/4), 2)),
  DCS=as.factor(round(c(1/3, 1/4, 3/4),2)),
  FOG=as.factor(round(c(2/3, 0, 0), 2))
)
sn <- merge(sn, recipes, by="Recipe")
write.csv(sn, "data/clean/cleaned_combined_minitrial_data.csv")
```

Note that the conditions were set to have 3 different loading rates, which we will treat as categorical because while they are numerical values of .5, 2, or 3.5, these are not observed values.  There for we set them to be factors (which allows for categories to be ranked by a inheirent value). 

Next, we can do some explortatory analysis:

```{r}
sn$OL <- as.factor(sn$OL)
ggscatmat(sn,  color="Recipe", alpha = .3) + theme(legend.position = "bottom") 
#ggpairs(sn, aes(color=Recipe, alpha=.5))

```

Initial observations:
- the original Box Behnken design can be seen looking at the top left area, seeing the distribution of values between Time, OL, and Temp.
- E. coli and Coliforms are, unsurprisingly, very highly correlated.
- TS and VS are highly correlated


Lets replot without some of the highly correlated ones that

```{r}
ggscatmat(sn %>% select(-TS, -Coliforms),  color="Recipe", alpha = .3) + theme(legend.position = "bottom")
```


Lets look at the indocators
### Enterococci
```{r}
ggplot(sn, aes(x=Time, y=Enterococci, color=as.factor(Temp))) +
  geom_point() + facet_wrap(~OL+Recipe)  + geom_smooth(method = lm) + 
  labs(caption=fn("Effect of OL and Recipe"), color="")
```

It looks like for FWS12 the levels of enterococci stay the same, but in all the FSW13, FWS31, the levels seems to increase or decrease over time. We can try to determine if that is due to   
```{r}

ggplot(sn, aes(x=Time, y=Enterococci, color=as.factor(Temp))) + 
  geom_point() + 
  labs(caption=fn("Effect of OL vs DCS"), color="") +
  facet_wrap(~OL+DCS)  + 
  geom_smooth(method = lm)

ggplot(sn, aes(x=Time, y=Enterococci, color=as.factor(Temp))) + 
  labs(caption=fn("Effect of OL vs RFW"), color="") +
  geom_point() + facet_wrap(~OL+RFW)  + 
  geom_smooth(method = lm)
ggplot(sn, aes(x=Time, y=Enterococci, color=as.factor(Temp))) +
  geom_point() + 
  labs(caption=fn("Effect of Temp"), color="") +
  facet_wrap(~RFW)  + geom_smooth(method = lm)
ggplot(sn, aes(x=Temp, y=Enterococci, color=as.factor(RFW))) + 
  labs(caption=fn("Effect of RFW"), color="") +
  geom_point() + geom_smooth(method = lm)

```
Those rates seem to indicate 2 things:

- that the higher proportion of restaurant food waste, the better enterococci survive
- regardless of the proportion of RFW, increased temperature inhibits Enterococci

### E. coli

```{r}
ggplot(sn, aes(x=Time, y=Ecoli, color=as.factor(Temp))) +
  geom_point() + 
  facet_wrap(~OL+Recipe)  +
  geom_smooth(method = lm) + 
  labs(caption=fn("Effect of OL and Recipe"), color="")
```

E coli counts seem to depend largely on Temp rather than OL or Recipe.


```{r}
ggplot(sn, aes(x=Time, y=Ecoli, color=as.factor(Temp))) +
  geom_point()  + geom_smooth(method = lm) + 
  labs(caption=fn("Effect of Temperature"), color="")
```
This may indicate that while die-off occurs at cold temperature, higher temperatue increases the die-off rate.


### Coliforms

Coliforms should be have the same as E. coli (as we saw theirr values being highly correlated), but lets observe:

```{r}
ggplot(sn, aes(x=Time, y=Coliforms, color=as.factor(Temp))) +
  geom_point()  + geom_smooth(method = lm) + 
  labs(caption=fn("Effect of Temperature"), color="")
```
Coliform counts too seem to depend largely on Temp rather than OL or Recipe.

## Ammonia

```{r}
ggplot(sn, aes(x=Time, y=Ammonia, color=as.factor(Temp))) +
  geom_point()  + geom_smooth(method = lm) + 
  facet_wrap(~Recipe )  +
  labs(caption=fn("Effect of Temperature and Recipe"), color="")
```
Across all recipes, Ammonia decreases as a function of time

## Methane
Methane is the only thing leaving the bioreactors (as biogas), and therefore was measured daily until detructive sampling at 3, 6, or 9 days.  We have aggregated the data in the original excel sheet.  

```{r}
ggplot(sn, aes(x=Time, y=Methane, color=as.factor(Recipe))) +
  geom_point()  + geom_smooth(method = lm) + 
  facet_wrap(~Temp )  +
  labs(caption=fn("Effect of Temperature and Recipe"), color="")
ggplot(sn, aes(x=Time, y=Methane, color=as.factor(Temp))) +
  geom_point()  + geom_smooth(method = lm) + 
  facet_wrap(~Recipe )  +
  labs(caption=fn("Effect of Temperature and Recipe"), color="")
ggplot(sn, aes(x=Time, y=Methane, color=as.factor(Temp))) +
  geom_point()  + geom_smooth(method = lm) + 
  facet_wrap(~Recipe + OL )  +
  labs(caption=fn("Effect of Temperature and OL"), color="")
```
It looks like the rate of poduction is highest at 37, and that at the optimal  feed stocks with a high OL yield high prroduction, expecially at 37.

## pH

```{r}
ggplot(sn, aes(x=Time, y=pH, color=as.factor(Recipe))) +
  geom_point()  + geom_smooth(method = lm) + 
  facet_wrap(~Temp )  +
  labs(caption=fn("Effect of Temperature and Recipe"), color="")

```

The range of pH is rerlatively tight, but it appears to drop with time at the temperature extremes, staying the most stable at 37

## Modelling

```{r}
stan_data = list(
    nbugs=3,
    nrows=nrow(sn),
    Temp=(sn$Temp -19)/18 + 1,
    Ammonia=sn$Ammonia,
    pH=sn$pH,
    Ecoli=sn$Ecoli,
    Coliforms=sn$Coliforms,
    Time=sn$Time,
    OL=ifelse(sn$OL==.5, 1, ifelse(sn$OL==3.5, 3, sn$OL)),
    Enterococci=sn$Enterococci,
    sCOD=sn$sCOD,
    VS=sn$VS,
    TS=sn$TS,
    Recipe=as.numeric(sn$Recipe),
    Methane=sn$Methane
  )
fit <- stan(
  file = "./models/model_min.stan",
  verbose = T,
  chains=4,
  data = stan_data
)
plot_pars <- c(names(fit)[!startsWith(prefix = "bugs", names(fit))])
plot(fit, pars=plot_pars, plotfun = "trace", inc_warmup = F, chains=T)

ggplot(data.frame(x = c(-5, 5)), aes(x)) +
    stat_function(fun = dcauchy, n = 1e3, args = list(location = 1, scale = 1))
stan_dens(fit, pars=c("recipe_effect") )
stan_dens(fit, pars=c("load_effect"))
plot(fit, pars=c("recipe_effect") )
plot(fit, pars=c("load_effect"))
plot(fit, pars=c("temp_effect"))
plot(fit, pars=c("lp__"))
plot(fit,  pars=c("lp__"),  plotfun = "trace", inc_warmup = F, chains=T)

stan_model(fit)
mle = optimizing(stan_model("./models/model_min.stan"), data=stan_data)
```



# change log

- 2019-05-02: after meeting, update calculations for day 0 values. 

- 2019-05-01: setup .Rmd, incorporate inital day 0 values
